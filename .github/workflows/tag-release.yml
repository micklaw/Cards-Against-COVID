name: Deploy on Tag Release

on:
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  DOTNET_VERSION: '8.0.x'
  NODE_VERSION: '20.x'
  AZURE_RESOURCE_GROUP: 'rgcardagainstcovid'
  AZURE_REGION: 'westeurope'

jobs:
  build-backend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup .NET
      uses: actions/setup-dotnet@v4
      with:
        dotnet-version: ${{ env.DOTNET_VERSION }}
        
    - name: Restore dependencies
      working-directory: ./api
      run: dotnet restore
      
    - name: Build solution
      working-directory: ./api
      run: dotnet build --configuration Release --no-restore
      
    - name: Publish API
      working-directory: ./api
      run: dotnet publish CardsAgainstHumanity.Api/CardsAgainstHumanity.Api.csproj --configuration Release --output ../api-output
      
    - name: Upload API artifact
      uses: actions/upload-artifact@v4
      with:
        name: api-package
        path: ./api-output

  build-frontend:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: Install dependencies
      working-directory: ./web
      run: npm ci
      
    - name: Build frontend
      working-directory: ./web
      run: npm run build
      
    - name: Upload frontend artifact
      uses: actions/upload-artifact@v4
      with:
        name: frontend-package
        path: ./web/dist

  deploy-infrastructure:
    runs-on: ubuntu-latest
    needs: [build-backend, build-frontend]
    outputs:
      resourceGroupName: ${{ steps.deploy.outputs.resourceGroupName }}
      functionAppName: ${{ steps.deploy.outputs.functionAppName }}
      staticWebAppName: ${{ steps.deploy.outputs.staticWebAppName }}
      staticWebAppUrl: ${{ steps.deploy.outputs.staticWebAppUrl }}
      
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy Bicep template at subscription level
      id: deploy
      run: |
        LOCATION="${{ env.AZURE_REGION }}"
        RESOURCE_GROUP="${{ env.AZURE_RESOURCE_GROUP }}"
        
        DEPLOYMENT_OUTPUT=$(az deployment sub create \
          --location "$LOCATION" \
          --template-file infrastructure/main-subscription.bicep \
          --parameters resourceGroupName="$RESOURCE_GROUP" \
          --parameters location="$LOCATION" \
          --parameters environmentName=prod \
          --parameters baseName=cah \
          --parameters storageAccountSku=Standard_LRS \
          --parameters functionAppSku=Y1 \
          --parameters functionAppSkuFamily=Y \
          --query 'properties.outputs' \
          --output json)
        
        echo "resourceGroupName=$(echo $DEPLOYMENT_OUTPUT | jq -r '.resourceGroupName.value')" >> $GITHUB_OUTPUT
        echo "functionAppName=$(echo $DEPLOYMENT_OUTPUT | jq -r '.functionAppName.value')" >> $GITHUB_OUTPUT
        echo "staticWebAppName=$(echo $DEPLOYMENT_OUTPUT | jq -r '.staticWebAppName.value')" >> $GITHUB_OUTPUT
        echo "staticWebAppUrl=$(echo $DEPLOYMENT_OUTPUT | jq -r '.staticWebAppUrl.value')" >> $GITHUB_OUTPUT

  deploy-function-app:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
    - name: Download API artifact
      uses: actions/download-artifact@v4
      with:
        name: api-package
        path: ./api-package
        
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Azure Functions
      uses: Azure/functions-action@v1
      with:
        app-name: ${{ needs.deploy-infrastructure.outputs.functionAppName }}
        package: ./api-package

  deploy-static-web-app:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Download frontend artifact
      uses: actions/download-artifact@v4
      with:
        name: frontend-package
        path: ./frontend-package
        
    - name: Azure Login
      uses: azure/login@v2
      with:
        creds: ${{ secrets.AZURE_CREDENTIALS }}
        
    - name: Deploy to Static Web App
      run: |
        TOKEN=$(az staticwebapp secrets list \
          --name ${{ needs.deploy-infrastructure.outputs.staticWebAppName }} \
          --resource-group ${{ needs.deploy-infrastructure.outputs.resourceGroupName }} \
          --query "properties.apiKey" -o tsv)
        echo "::add-mask::$TOKEN"
        echo "deployment_token=$TOKEN" >> $GITHUB_OUTPUT
        
    - name: Deploy to Azure Static Web Apps
      uses: Azure/static-web-apps-deploy@v1
      with:
        azure_static_web_apps_api_token: ${{ steps.static_web_app_token.outputs.deployment_token }}
        repo_token: ${{ secrets.GITHUB_TOKEN }}
        action: "upload"
        app_location: "./frontend-package"
        skip_app_build: true
          
    - name: Deployment Summary
      run: |
        echo "## Deployment Complete! ðŸš€" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Tag**: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Resource Group**: ${{ needs.deploy-infrastructure.outputs.resourceGroupName }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Static Web App URL**: ${{ needs.deploy-infrastructure.outputs.staticWebAppUrl }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Function App**: ${{ needs.deploy-infrastructure.outputs.functionAppName }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Environment**: Production" >> $GITHUB_STEP_SUMMARY

  create-release:
    runs-on: ubuntu-latest
    needs: [deploy-function-app, deploy-static-web-app]
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        generate_release_notes: true
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
